<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Welcome to Firebase Hosting</title>

		<!-- update the version number as needed -->
		<script defer src="/__/firebase/8.2.10/firebase-app.js"></script>
		<!-- include only the Firebase features as you need -->
		<script defer src="/__/firebase/8.2.10/firebase-auth.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-database.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-firestore.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-functions.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-messaging.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-storage.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-analytics.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-remote-config.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-performance.js"></script>
		<script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
		<link
			type="text/css"
			rel="stylesheet"
			href="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.css"
		/>
		<!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
		<script defer src="/__/firebase/init.js?useEmulator=true"></script>

		<style media="screen">
			body {
				background: #eceff1;
				color: rgba(0, 0, 0, 0.87);
				font-family: Roboto, Helvetica, Arial, sans-serif;
				margin: 0;
				padding: 0;
			}

			#message {
				background: white;
				max-width: 360px;
				margin: 100px auto 16px;
				padding: 32px 24px;
				border-radius: 3px;
			}

			#message h2 {
				color: #ffa100;
				font-weight: bold;
				font-size: 16px;
				margin: 0 0 8px;
			}

			#message h1 {
				font-size: 22px;
				font-weight: 300;
				color: rgba(0, 0, 0, 0.6);
				margin: 0 0 16px;
			}

			#message p {
				line-height: 140%;
				margin: 16px 0 24px;
				font-size: 14px;
			}

			#message a {
				display: block;
				text-align: center;
				background: #039be5;
				text-transform: uppercase;
				text-decoration: none;
				color: white;
				padding: 16px;
				border-radius: 4px;
			}

			#message,
			#message a {
				box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
			}

			#load {
				color: rgba(0, 0, 0, 0.4);
				text-align: center;
				font-size: 13px;
			}

			@media (max-width: 600px) {
				body,
				#message {
					margin-top: 0;
					background: white;
					box-shadow: none;
				}

				body {
					border-top: 16px solid #ffa100;
				}
			}
		</style>
	</head>

	<body>
		<div id="message">
			<h2>Welcome</h2>
			<h1>BƒÅngW≈è</h1>
			<p id="description" style="width: 350px; word-wrap: break-word">
				Please Log In or Sign Up With You Phone Number
			</p>
			<!-- <a target="_blank" href="https://firebase.google.com/docs/hosting/"
				>Open Hosting Documentation</a
			> -->
			<div id="firebaseui-auth-container"></div>
		</div>
		<!-- <p id="load">Firebase SDK Loading&hellip;</p> -->

		<script>
			document.addEventListener('DOMContentLoaded', function () {
				const loadEl = document.querySelector('#load');
				// // üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•
				// // The Firebase SDK is initialized and available here!
				//
				// firebase.auth().onAuthStateChanged(user => { });
				// firebase.database().ref('/path/to/ref').on('value', snapshot => { });
				// firebase.firestore().doc('/foo/bar').get().then(() => { });
				// firebase.functions().httpsCallable('yourFunction')().then(() => { });
				// firebase.messaging().requestPermission().then(() => { });
				// firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
				// firebase.analytics(); // call to activate
				// firebase.analytics().logEvent('tutorial_completed');
				// firebase.performance(); // call to activate
				//
				// // üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•

				try {
					let app = firebase.app();
					let features = [
						'auth',
						'database',
						'firestore',
						'functions',
						'messaging',
						'storage',
						'analytics',
						'remoteConfig',
						'performance',
					].filter((feature) => typeof app[feature] === 'function');
					// loadEl.textContent = `Firebase SDK loaded with ${features.join(
					// 	', '
					// )}`;

					firebase.auth().onAuthStateChanged(function (user) {
						if (user) {
							alert('You are logged in!');
							console.log('[User Info]', JSON.stringify(user));
							document.getElementById(
								'firebaseui-auth-container'
							).innerHTML = `<button id="signOutBtn" onclick="signMeOut()">Sign Out</button>
							<button style="margin-top:10px " id="secondStepBtn" ><a style="background:initial; padding:initial; width:initial; height:initial; color:black"  href="./newUser.html">Go to Step 2) Add Name & Profile Pic</a></button>`;

							addNewUserPhone(user.phoneNumber, user.uid).then((msg) => {
								alert(JSON.stringify(msg));
								document.getElementById(
									'description'
								).innerText = JSON.stringify(msg);
							});
						} else {
							// No user is signed in.
							alert('You are not logged in!');
							var ui = new firebaseui.auth.AuthUI(firebase.auth());
							ui.start('#firebaseui-auth-container', {
								signInOptions: [
									{
										provider: firebase.auth.PhoneAuthProvider.PROVIDER_ID,
										recaptchaParameters: {
											type: 'image', // 'audio'
											size: 'invisible', // 'invisible' or 'compact'
											badge: 'bottomleft', //' bottomright' or 'inline' applies to invisible.
										},
										defaultCountry: 'SG',
									},
								],
							});
						}
					});
				} catch (e) {
					console.error(e);
					loadEl.textContent =
						'Error loading the Firebase SDK, check the console.';
				}
			});

			function signMeOut() {
				firebase
					.auth()
					.signOut()
					.then(() => {
						// Sign-out successful.
						alert('Successfully Sign Out!');
						document.getElementById('signOutBtn').remove();
						location.reload();
					})
					.catch((error) => {
						// An error happened.
					});
			}

			async function addNewUserPhone(phoneNo, uid) {
				const addNewUserPhoneFB = firebase
					.functions()
					.httpsCallable('addNewUserPhone');

				let msg = '';
				await addNewUserPhoneFB({
					uid: uid,
					phoneNo: phoneNo,
				}).then((result) => {
					if (result.data.profileData.profilePicUrl) {
						console.log('This is true');
						document.getElementById('secondStepBtn').style.visibility =
							'hidden';
						document.getElementById(
							'firebaseui-auth-container'
						).innerHTML += `	<button style="margin-top:10px " id="ThirdStepBtn" ><a style="background:initial; padding:initial; width:initial; height:initial; color:black"  href="./newUser.html">Go to Last Step 3 ) Add Home Address</a></button>`;
					}

					if (result.data.profileData.address) {
						console.log('This is true');
						document.getElementById('ThirdStepBtn').style.visibility = 'hidden';
						document.getElementsByTagName('h1')[0].innerText =
							'YOUR BANG WO PROFILE IS COMPLETED with your 1) Name 2) Profile Pic 3) Address 4) Unit No!';
					}

					msg = result.data;
				});

				return msg;
			}
		</script>
	</body>
</html>
