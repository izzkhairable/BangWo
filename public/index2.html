<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Welcome to Firebase Hosting</title>

		<!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

		<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
		<script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-app.js"></script>

		<!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
		<script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-analytics.js"></script>

		<!-- Add Firebase products that you want to use -->
		<script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-auth.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-firestore.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-functions.js"></script>

		<!-- Firebase Auth UI -->
		<script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
		<link
			type="text/css"
			rel="stylesheet"
			href="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.css"
		/>

		<style media="screen">
			body {
				background: #eceff1;
				color: rgba(0, 0, 0, 0.87);
				font-family: Roboto, Helvetica, Arial, sans-serif;
				margin: 0;
				padding: 0;
			}
			#message {
				background: white;
				max-width: 360px;
				margin: 100px auto 16px;
				padding: 32px 24px;
				border-radius: 3px;
			}
			#message h2 {
				color: #ffa100;
				font-weight: bold;
				font-size: 16px;
				margin: 0 0 8px;
			}
			#message h1 {
				font-size: 22px;
				font-weight: 300;
				color: rgba(0, 0, 0, 0.6);
				margin: 0 0 16px;
			}
			#message p {
				line-height: 140%;
				margin: 16px 0 24px;
				font-size: 14px;
			}
			#message a {
				display: block;
				text-align: center;
				background: #039be5;
				text-transform: uppercase;
				text-decoration: none;
				color: white;
				padding: 16px;
				border-radius: 4px;
			}
			#message,
			#message a {
				box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
			}
			#load {
				color: rgba(0, 0, 0, 0.4);
				text-align: center;
				font-size: 13px;
			}
			@media (max-width: 600px) {
				body,
				#message {
					margin-top: 0;
					background: white;
					box-shadow: none;
				}
				body {
					border-top: 16px solid #ffa100;
				}
			}
		</style>
	</head>
	<body>
		<div id="message">
			<h2>Welcome</h2>
			<h1>BāngWŏ</h1>
			<p id="description" style="width: 350px; word-wrap: break-word">
				Please Log In or Sign Up With You Phone Number
			</p>
			<div id="firebaseui-auth-container"></div>
		</div>

		<script>
			document.addEventListener('DOMContentLoaded', function () {
				const loadEl = document.querySelector('#load');

				try {
					// Your web app's Firebase configuration
					// For Firebase JS SDK v7.20.0 and later, measurementId is optional
					var firebaseConfig = {
						apiKey: 'AIzaSyBMfIYXcCxwtQKtzsk1BM5ahgUYJMO1qdM',
						authDomain: 'bangwo-d7640.firebaseapp.com',
						databaseURL: 'https://bangwo-d7640-default-rtdb.firebaseio.com',
						projectId: 'bangwo-d7640',
						storageBucket: 'bangwo-d7640.appspot.com',
						messagingSenderId: '781540815121',
						appId: '1:781540815121:web:a9ab486ce1a084a4ff5cb0',
						measurementId: 'G-GYD6TC5HLR',
					};
					// Initialize Firebase
					firebase.initializeApp(firebaseConfig);
					firebase.analytics();

					firebase.auth().onAuthStateChanged(function (user) {
						if (user) {
							alert('You are logged in!');
							console.log('[User Info]', JSON.stringify(user));
							document.getElementById(
								'firebaseui-auth-container'
							).innerHTML = `<button id="signOutBtn" onclick="signMeOut()">Sign Out</button>
							<button ><a style="" href="./newUser.html">Add Name & Profile Pic</a></button>`;

							addNewUserPhone(user.phoneNumber, user.uid).then((msg) => {
								alert(JSON.stringify(msg));
								document.getElementById(
									'description'
								).innerText = JSON.stringify(msg);
							});
						} else {
							// No user is signed in.
							alert('You are not logged in!');
							var ui = new firebaseui.auth.AuthUI(firebase.auth());
							ui.start('#firebaseui-auth-container', {
								signInOptions: [
									{
										provider: firebase.auth.PhoneAuthProvider.PROVIDER_ID,
										recaptchaParameters: {
											type: 'image',
											size: 'invisible',
											badge: 'bottomleft',
										},
										defaultCountry: 'SG',
									},
								],
							});
						}
					});
				} catch (e) {
					console.error(e);
					loadEl.textContent =
						'Error loading the Firebase SDK, check the console.';
				}
			});

			function signMeOut() {
				firebase
					.auth()
					.signOut()
					.then(() => {
						// Sign-out successful.
						alert('Successfully Sign Out!');
						document.getElementById('signOutBtn').remove();
						location.reload();
					})
					.catch((error) => {
						// An error happened.
					});
			}

			async function addNewUserPhone(phoneNo, uid) {
				const addNewUserPhoneFB = firebase
					.functions()
					.httpsCallable('addNewUserPhone');

				let msg = '';
				await addNewUserPhoneFB({ uid: uid, phoneNo: phoneNo }).then(
					(result) => {
						msg = result.data;
					}
				);
				return msg;
			}
		</script>
	</body>
</html>
