<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Welcome to Firebase Hosting</title>

		<script defer src="/__/firebase/8.2.10/firebase-app.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-auth.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-database.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-firestore.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-functions.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-messaging.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-storage.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-analytics.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-remote-config.js"></script>
		<script defer src="/__/firebase/8.2.10/firebase-performance.js"></script>
		<script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
		<link
			type="text/css"
			rel="stylesheet"
			href="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.css"
		/>
		<script defer src="/__/firebase/init.js?useEmulator=true"></script>
	</head>

	<body>
		<div id="message">
			<h2>Welcome Volunteer</h2>
			<h1>BāngWŏ</h1>
			<p id="description" style="width: 350px; word-wrap: break-word">
				Please Log In or Sign Up With You Phone Number
			</p>
			<div id="firebaseui-auth-container"></div>
		</div>

		<script>
			document.addEventListener('DOMContentLoaded', function () {
				const loadEl = document.querySelector('#load');

				try {
					let app = firebase.app();

					firebase.auth().onAuthStateChanged(function (user) {
						if (user) {
							alert('You are logged in!');
							document.getElementById(
								'firebaseui-auth-container'
							).innerHTML = `<button id="signOutBtn" onclick="signMeOut()">Sign Out</button>
							<button style="margin-top:10px " id="secondStepBtn" ><a style="background:initial; padding:initial; width:initial; height:initial; color:black"  href="./signUpStep2.html">Go to Step 2) Add Name & Profile Pic</a></button>`;

							addNewUserPhone(user.phoneNumber, user.uid).then((msg) => {
								alert(JSON.stringify(msg));
								document.getElementById(
									'description'
								).innerText = JSON.stringify(msg);
							});
						} else {
							// No user is signed in.
							alert('You are not logged in!');
							var ui = new firebaseui.auth.AuthUI(firebase.auth());
							ui.start('#firebaseui-auth-container', {
								signInOptions: [
									{
										provider: firebase.auth.PhoneAuthProvider.PROVIDER_ID,
										recaptchaParameters: {
											type: 'image',
											size: 'invisible',
											badge: 'bottomleft',
										},
										defaultCountry: 'SG',
									},
								],
							});
						}
					});
				} catch (e) {
					console.error(e);
					loadEl.textContent =
						'Error loading the Firebase SDK, check the console.';
				}
			});

			function signMeOut() {
				firebase
					.auth()
					.signOut()
					.then(() => {
						// Sign-out successful.
						alert('Successfully Sign Out!');
						document.getElementById('signOutBtn').remove();
						location.reload();
					})
					.catch((error) => {
						// An error happened.
					});
			}

			async function addNewUserPhone(phoneNo, uid) {
				const addNewUserPhoneFB = firebase
					.functions()
					.httpsCallable('loginORsignUpVolunteerStep1');
				let msg = '';
				await addNewUserPhoneFB({
					uid: uid,
					phoneNo: phoneNo,
				}).then((result) => {
					if (result.data.profileData.profilePicUrl) {
						document.getElementById('secondStepBtn').style.visibility =
							'hidden';
						document.getElementById(
							'firebaseui-auth-container'
						).innerHTML += `<button style="margin-top:10px " id="ThirdStepBtn" ><a style="background:initial; padding:initial; width:initial; height:initial; color:black"  href="./signUpStep3.html">Go to Last Step 3 ) Add Home Address</a></button>`;
					}

					if (result.data.profileData.address) {
						document.getElementById('ThirdStepBtn').style.visibility = 'hidden';
						document.getElementsByTagName('h1')[0].innerText =
							'YOUR BANG WO PROFILE IS COMPLETED with your 1) Name 2) Profile Pic 3) Address 4) Unit No';
					}

					msg = result.data;
				});

				return msg;
			}
		</script>
	</body>
</html>
